"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=processImport;var _typescript=_interopRequireDefault(require("typescript")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_pre_define=require("./pre_define"),_validate_ui_syntax=require("./validate_ui_syntax");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function processImport(e,t,i){var r,a,n=this,o=new Map;_typescript.default.isImportDeclaration(e)||_typescript.default.isExportDeclaration(e)?(r=e.moduleSpecifier.getText().replace(/'|"/g,""),_typescript.default.isImportDeclaration(e)&&e.importClause&&e.importClause.name&&_typescript.default.isIdentifier(e.importClause.name)&&(a=e.importClause.name.escapedText.toString()),_typescript.default.isImportDeclaration(e)&&e.importClause&&e.importClause.namedBindings&&_typescript.default.isNamedImports(e.importClause.namedBindings)&&e.importClause.namedBindings.elements&&e.importClause.namedBindings.elements.forEach(function(e){_newArrowCheck(this,n),e.name&&e.propertyName&&_typescript.default.isIdentifier(e.name)&&_typescript.default.isIdentifier(e.propertyName)&&o.set(e.propertyName.escapedText.toString(),e.name.escapedText.toString())}.bind(this))):e.moduleReference&&_typescript.default.isExternalModuleReference(e.moduleReference)&&e.moduleReference.expression&&_typescript.default.isStringLiteral(e.moduleReference.expression)&&(r=e.moduleReference.expression.text,a=e.name.escapedText.toString()),r&&_path.default.extname(r)!==_pre_define.EXTNAME_ETS&&!isModule(r)&&(r+=_pre_define.EXTNAME_ETS);try{var s;if(s=/^(\.|\.\.)\//.test(r)?_path.default.join(t,r):/^\//.test(r)?r:getFileResolvePath(s,t,r),_fs.default.existsSync(s)&&_fs.default.statSync(s).isFile()){var l=(0,_validate_ui_syntax.preprocessNewExtend)((0,_validate_ui_syntax.preprocessExtend)((0,_validate_ui_syntax.processSystemApi)(_fs.default.readFileSync(s,{encoding:"utf-8"}).replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b.+\\{","g"),function(e){return _newArrowCheck(this,n),e.replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b","g"),"".concat(_pre_define.CLASS," "))}.bind(this)))));visitAllNode(_typescript.default.createSourceFile(r,l,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.TS),a,o,t,i)}}catch(e){}}function visitAllNode(e,t,i,r,a){var n=this;(0,_validate_ui_syntax.isObservedClass)(e)&&_validate_ui_syntax.observedClassCollection.add(e.name.getText()),(0,_validate_ui_syntax.isCustomDialogClass)(e)&&_validate_ui_syntax.componentCollection.customDialogs.add(e.name.getText()),_typescript.default.isEnumDeclaration(e)&&e.name&&_validate_ui_syntax.enumCollection.add(e.name.getText()),_typescript.default.isClassDeclaration(e)&&_typescript.default.isIdentifier(e.name)&&isCustomComponent(e)&&(addDependencies(e,t,i),!t&&e.modifiers&&e.modifiers.length>=2&&e.modifiers[0]&&e.modifiers[0].kind===_typescript.default.SyntaxKind.ExportKeyword&&e.modifiers[1]&&e.modifiers[1].kind===_typescript.default.SyntaxKind.DefaultKeyword&&hasCollection(e.name)&&addDefaultExport(e)),_typescript.default.isExportAssignment(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)&&hasCollection(e.expression)&&(t&&setDependencies(t,_validate_ui_syntax.linkCollection.get(e.expression.escapedText.toString()),_validate_ui_syntax.propertyCollection.get(e.expression.escapedText.toString()),_validate_ui_syntax.propCollection.get(e.expression.escapedText.toString())),addDefaultExport(e)),_typescript.default.isExportDeclaration(e)&&e.exportClause&&_typescript.default.isNamedExports(e.exportClause)&&e.exportClause.elements&&e.exportClause.elements.forEach(function(e){if(_newArrowCheck(this,n),e.name&&e.propertyName&&_typescript.default.isIdentifier(e.name)&&_typescript.default.isIdentifier(e.propertyName)&&hasCollection(e.propertyName)){var t=e.name.escapedText.toString(),r=e.propertyName.escapedText.toString();i.has(t)&&(t=i.get(t)),setDependencies(t,_validate_ui_syntax.linkCollection.get(r),_validate_ui_syntax.propertyCollection.get(r),_validate_ui_syntax.propCollection.get(r))}}.bind(this)),_typescript.default.isExportDeclaration(e)&&e.moduleSpecifier&&_typescript.default.isStringLiteral(e.moduleSpecifier)&&processImport(e,r,a),e.getChildren().forEach(function(e){return _newArrowCheck(this,n),visitAllNode(e,t,i,r,a)}.bind(this))}function addDependencies(e,t,i){var r=e.name.getText(),a=(0,_validate_ui_syntax.getComponentSet)(e);t&&e.modifiers&&e.modifiers.length>=2&&e.modifiers[0]&&e.modifiers[1]&&e.modifiers[0].kind===_typescript.default.SyntaxKind.ExportKeyword&&e.modifiers[1].kind===_typescript.default.SyntaxKind.DefaultKeyword?setDependencies(t,a.links,a.propertys,a.props):i.has(r)?setDependencies(i.get(r),a.links,a.propertys,a.props):setDependencies(r,a.links,a.propertys,a.props)}function addDefaultExport(e){var t;if(_typescript.default.isClassDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name))t=e.name.escapedText.toString();else{if(!(_typescript.default.isExportAssignment(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)))return;t=e.expression.escapedText.toString()}setDependencies(_pre_define.CUSTOM_COMPONENT_DEFAULT,_validate_ui_syntax.linkCollection.has(_pre_define.CUSTOM_COMPONENT_DEFAULT)?new Set([].concat(_toConsumableArray(_validate_ui_syntax.linkCollection.get(_pre_define.CUSTOM_COMPONENT_DEFAULT)),_toConsumableArray(_validate_ui_syntax.linkCollection.get(t)))):_validate_ui_syntax.linkCollection.get(t),_validate_ui_syntax.propertyCollection.has(_pre_define.CUSTOM_COMPONENT_DEFAULT)?new Set([].concat(_toConsumableArray(_validate_ui_syntax.propertyCollection.get(_pre_define.CUSTOM_COMPONENT_DEFAULT)),_toConsumableArray(_validate_ui_syntax.propertyCollection.get(t)))):_validate_ui_syntax.propertyCollection.get(t),_validate_ui_syntax.propCollection.has(_pre_define.CUSTOM_COMPONENT_DEFAULT)?new Set([].concat(_toConsumableArray(_validate_ui_syntax.propCollection.get(_pre_define.CUSTOM_COMPONENT_DEFAULT)),_toConsumableArray(_validate_ui_syntax.propCollection.get(t)))):_validate_ui_syntax.propCollection.get(t))}function setDependencies(e,t,i,r){_validate_ui_syntax.linkCollection.set(e,t),_validate_ui_syntax.propertyCollection.set(e,i),_validate_ui_syntax.propCollection.set(e,r),_validate_ui_syntax.componentCollection.customComponents.add(e)}function hasCollection(e){return _validate_ui_syntax.linkCollection.has(e.escapedText.toString())||_validate_ui_syntax.propCollection.has(e.escapedText.toString())||_validate_ui_syntax.propertyCollection.has(e.escapedText.toString())}function isModule(e){return!/^(\.|\.\.)?\//.test(e)}function isCustomComponent(e){if(e.decorators&&e.decorators.length)for(var t=0;t<e.decorators.length;++t){var i=e.decorators[t].expression;if(_typescript.default.isIdentifier(i)&&_pre_define.CUSTOM_DECORATOR_NAME.has(i.escapedText.toString()))return!0}return!1}function isPackageJsonEntry(e){var t=_path.default.join(e,_pre_define.PACKAGE_JSON);if(_fs.default.existsSync(t)){var i;try{i=JSON.parse(_fs.default.readFileSync(t).toString()).main}catch(e){return!1}if("string"==typeof i&&_fs.default.existsSync(_path.default.join(e,i)))return!0}}function getPackageJsonEntry(e){return _path.default.join(e,JSON.parse(_fs.default.readFileSync(_path.default.join(e,_pre_define.PACKAGE_JSON)).toString()).main)}function getModuleFilePath(e){return e&&_path.default.extname(e)!==_pre_define.EXTNAME_ETS&&isModule(e)&&(e+=_pre_define.EXTNAME_ETS),e}function getFileResolvePath(e,t,i){var r=getModuleFilePath(i),a=_path.default.join(t,"../",r);if(_fs.default.existsSync(a))return a;var n=_path.default.join(t,"../../../../../../",r);if(_fs.default.existsSync(n))return n;for(var o=t;!_fs.default.existsSync(e)&&(e=_path.default.join(o,_pre_define.NODE_MODULES,i),_fs.default.existsSync(e+_pre_define.EXTNAME_ETS)?e+=_pre_define.EXTNAME_ETS:isPackageJsonEntry(e)?e=getPackageJsonEntry(e):_fs.default.existsSync(_path.default.join(e,_pre_define.INDEX_ETS))&&(e=_path.default.join(e,_pre_define.INDEX_ETS)),o!==_path.default.parse(o).root);)o=_path.default.dirname(o);return e}
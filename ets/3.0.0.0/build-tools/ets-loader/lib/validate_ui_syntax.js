"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateUISyntax=validateUISyntax,exports.isObservedClass=isObservedClass,exports.isCustomDialogClass=isCustomDialogClass,exports.getComponentSet=getComponentSet,exports.sourceReplace=sourceReplace,exports.preprocessExtend=preprocessExtend,exports.preprocessNewExtend=preprocessNewExtend,exports.processSystemApi=processSystemApi,exports.resetComponentCollection=resetComponentCollection,exports.moduleCollection=exports.isStaticViewCollection=exports.objectLinkCollection=exports.consumeCollection=exports.provideCollection=exports.storageLinkCollection=exports.storagePropCollection=exports.regularCollection=exports.propCollection=exports.linkCollection=exports.stateCollection=exports.propertyCollection=exports.dollarCollection=exports.classMethodCollection=exports.enumCollection=exports.observedClassCollection=exports.componentCollection=void 0;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_pre_define=require("./pre_define"),_component_map=require("./component_map"),_utils=require("./utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=new Array(t);o<t;o++)n[o]=e[o];return n}var componentCollection={entryComponent:null,previewComponent:null,customDialogs:new Set([]),customComponents:new Set([]),currentClassName:null};exports.componentCollection=componentCollection;var observedClassCollection=new Set;exports.observedClassCollection=observedClassCollection;var enumCollection=new Set;exports.enumCollection=enumCollection;var classMethodCollection=new Map;exports.classMethodCollection=classMethodCollection;var dollarCollection=new Set;exports.dollarCollection=dollarCollection;var propertyCollection=new Map;exports.propertyCollection=propertyCollection;var stateCollection=new Map;exports.stateCollection=stateCollection;var linkCollection=new Map;exports.linkCollection=linkCollection;var propCollection=new Map;exports.propCollection=propCollection;var regularCollection=new Map;exports.regularCollection=regularCollection;var storagePropCollection=new Map;exports.storagePropCollection=storagePropCollection;var storageLinkCollection=new Map;exports.storageLinkCollection=storageLinkCollection;var provideCollection=new Map;exports.provideCollection=provideCollection;var consumeCollection=new Map;exports.consumeCollection=consumeCollection;var objectLinkCollection=new Map;exports.objectLinkCollection=objectLinkCollection;var isStaticViewCollection=new Map;exports.isStaticViewCollection=isStaticViewCollection;var moduleCollection=new Set;function validateUISyntax(e,t,o,n){var s=this,i=[];if("app.ets"!==_path.default.basename(o)){var r=checkComponentDecorator(e,o,n);r&&(i=i.concat(r)),checkUISyntax(o,new Set([].concat(_toConsumableArray(_component_map.INNER_COMPONENT_NAMES),_toConsumableArray(componentCollection.customComponents))),t,i),componentCollection.customComponents.forEach(function(e){return _newArrowCheck(this,s),_utils.componentInfo.componentNames.add(e)}.bind(this))}return i}function checkComponentDecorator(e,t,o){var n=this,s=[],i=_typescript.default.createSourceFile(t,e,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.TS);if(i&&i.statements&&i.statements.length){var r={entryCount:0,previewCount:0};i.statements.forEach(function(e,t,o){if(_newArrowCheck(this,n),isObservedClass(e)&&observedClassCollection.add(e.name.getText()),_typescript.default.isEnumDeclaration(e)&&e.name&&enumCollection.add(e.name.getText()),isStruct(e))if(t+1<o.length&&_typescript.default.isExpressionStatement(o[t+1])&&o[t+1].expression&&_typescript.default.isIdentifier(o[t+1].expression))if(_typescript.default.isExportAssignment(e)&&hasComponentDecorator(e))checkDecorators(e,r,o[t+1],s,i);else if(t>0&&hasComponentDecorator(o[t-1]))checkDecorators(o[t-1],r,o[t+1],s,i);else{var a=e.expression.getStart();(0,_utils.addLog)(_utils.LogType.WARN,"A struct should use decorator '@Component'.",a,s,i)}else{var c=e.expression.getStart();(0,_utils.addLog)(_utils.LogType.ERROR,"A struct must have a name.",c,s,i)}if(_typescript.default.isMissingDeclaration(e)&&/struct/.test(e.getText())){(0,_utils.addLog)(_utils.LogType.ERROR,"Please use a valid decorator.",e.getStart(),s,i)}}.bind(this)),validateEntryCount(r,o,i.fileName,s)}return s.length?s:null}function validateEntryCount(e,t,o,n){1!==e.entryCount&&"?entry"===t&&n.push({type:_utils.LogType.ERROR,message:"A page must have one and only one '@Entry' decorator with a struct.",fileName:o})}function isObservedClass(e){return!(!_typescript.default.isClassDeclaration(e)||!(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_OBSERVED_DECORATOR))}function isCustomDialogClass(e){return!(!_typescript.default.isClassDeclaration(e)||!(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_DECORATOR_CUSTOM_DIALOG))}function isStruct(e){return!(!_typescript.default.isExpressionStatement(e)&&!_typescript.default.isExportAssignment(e)||!e.expression||!_typescript.default.isIdentifier(e.expression)||e.expression.getText()!==_pre_define.STRUCT)}function hasComponentDecorator(e){return!(!_typescript.default.isMissingDeclaration(e)&&!_typescript.default.isExportAssignment(e)||!e.decorators||!e.decorators.length)}function checkDecorators(e,t,o,n,s){var i=this,r=!1,a=o.getText();if(e.decorators.forEach(function(e){_newArrowCheck(this,i);var o=e.getText();if(_pre_define.INNER_COMPONENT_DECORATORS.has(o))switch(componentCollection.customComponents.add(a),o){case _pre_define.COMPONENT_DECORATOR_ENTRY:t.entryCount++,componentCollection.entryComponent=a;break;case _pre_define.COMPONENT_DECORATOR_PREVIEW:t.previewCount++,componentCollection.previewComponent=a;break;case _pre_define.COMPONENT_DECORATOR_COMPONENT:r=!0;break;case _pre_define.COMPONENT_DECORATOR_CUSTOM_DIALOG:componentCollection.customDialogs.add(a),r=!0}else{var c=e.expression?e.expression.pos:e.pos,p="The struct '".concat(a,"' use invalid decorator.");(0,_utils.addLog)(_utils.LogType.WARN,p,c,n,s)}}.bind(this)),!r){var c="The struct '".concat(a,"' should use decorator '@Component'.");(0,_utils.addLog)(_utils.LogType.WARN,c,o.pos,n,s)}if(_component_map.BUILDIN_STYLE_NAMES.has(a)){var p="The struct '".concat(a,"' cannot have the same name as the built-in attribute '").concat(a,"'.");(0,_utils.addLog)(_utils.LogType.ERROR,p,o.pos,n,s)}}function checkUISyntax(e,t,o,n){var s=_typescript.default.createSourceFile(e,o,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.TS);visitAllNode(s,s,t,n)}function visitAllNode(e,t,o,n){var s=this;checkAllNode(e,o,t,n),_typescript.default.isClassDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name)&&collectComponentProps(e),e.getChildren().forEach(function(e){return _newArrowCheck(this,s),visitAllNode(e,t,o,n)}.bind(this))}function checkAllNode(e,t,o,n){if(_typescript.default.isExpressionStatement(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)&&t.has(e.expression.escapedText.toString())){var s=e.expression.getStart(),i="The component name must be followed by parentheses, like '".concat(e.expression.getText(),"()'.");(0,_utils.addLog)(_utils.LogType.ERROR,i,s,n,o)}checkNoChildComponent(e,o,n),checkOneChildComponent(e,t,o,n),checkSpecificChildComponent(e,t,o,n)}function checkNoChildComponent(e,t,o){if(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasChild(e)){var n=e.expression.expression.escapedText.toString(),s=e.expression.expression.getStart(),i="The component '".concat(n,"' can't have any child.");(0,_utils.addLog)(_utils.LogType.ERROR,i,s,o,t)}}function hasChild(e){var t=e.expression.expression;return!(!_component_map.AUTOMIC_COMPONENT.has(t.escapedText.toString())||!getNextNode(e))}function getNextNode(e){if(e.parent&&_typescript.default.isBlock(e.parent)&&e.parent.statements)for(var t=Array.from(e.parent.statements),o=0;o<t.length-1;o++){var n=t[o],s=t[o+1];if(e===n&&_typescript.default.isBlock(s))return s}}function checkOneChildComponent(e,t,o,n){if(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasNonSingleChild(e,t)){var s=e.expression.expression.escapedText.toString(),i=e.expression.expression.getStart(),r="The component '".concat(s,"' can only have a single child component.");(0,_utils.addLog)(_utils.LogType.ERROR,r,i,n,o)}}function hasNonSingleChild(e,t){var o=e.expression.expression,n=getNextNode(e);if(_component_map.SINGLE_CHILD_COMPONENT.has(o.escapedText.toString())){if(!n)return!1;if(n&&n.statements){var s=n.statements.length;if(!s)return!1;if(s>3)return!0;if(getBlockChildrenCount(n,t)>1)return!0}}return!1}function getBlockChildrenCount(e,t){for(var o=0,n=e.statements.length,s=0;s<n;++s){var i=e.statements[s];if(_typescript.default.isExpressionStatement(i)&&_typescript.default.isCallExpression(i.expression)&&isForEachComponent(i.expression)&&(o+=2),_typescript.default.isIfStatement(i)&&(o+=getIfChildrenCount(i,t)),_typescript.default.isBlock(i)&&(o+=getBlockChildrenCount(i,t)),_typescript.default.isExpressionStatement(i)&&_typescript.default.isCallExpression(i.expression)&&!isForEachComponent(i.expression)&&isComponent(i.expression,t)&&(o+=1,s+1<n&&_typescript.default.isBlock(e.statements[s+1])&&++s),o>1)break}return o}function isComponent(e,t){return!(!_typescript.default.isIdentifier(e.expression)||!t.has(e.expression.escapedText.toString()))}function isForEachComponent(e){if(_typescript.default.isIdentifier(e.expression)){var t=e.expression.escapedText.toString();return t===_pre_define.COMPONENT_FOREACH||t===_pre_define.COMPONENT_LAZYFOREACH}return!1}function getIfChildrenCount(e,t){return Math.max(getStatementCount(e.thenStatement,t),getStatementCount(e.elseStatement,t))}function getStatementCount(e,t){var o=0;return e?(_typescript.default.isBlock(e)?o=getBlockChildrenCount(e,t):_typescript.default.isIfStatement(e)?o=getIfChildrenCount(e,t):_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&isForEachComponent(e.expression)?o=2:_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&!isForEachComponent(e.expression)&&isComponent(e.expression,t)&&(o=1),o):o}function checkSpecificChildComponent(e,t,o,n){if(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasNonspecificChild(e,t)){var s=e.expression.expression.escapedText.toString(),i=e.expression.expression.getStart(),r=Array.from(_component_map.SPECIFIC_CHILD_COMPONENT.get(s)).join(" and "),a="The component '".concat(s,"' can only have the child component ").concat(r,".");(0,_utils.addLog)(_utils.LogType.ERROR,a,i,n,o)}}function hasNonspecificChild(e,t){var o=e.expression.expression.escapedText.toString(),n=getNextNode(e),s=!1;if(_component_map.SPECIFIC_CHILD_COMPONENT.has(o)&&n&&(s=isNonspecificChildBlock(n,_component_map.SPECIFIC_CHILD_COMPONENT.get(o),t)))return s;return s}function isNonspecificChildBlock(e,t,o){if(e.statements)for(var n=e.statements.length,s=0;s<n;++s){var i=e.statements[s];if(_typescript.default.isIfStatement(i)&&isNonspecificChildIf(i,t,o))return!0;if(_typescript.default.isExpressionStatement(i)&&_typescript.default.isCallExpression(i.expression)&&isForEachComponent(i.expression)&&isNonspecificChildForEach(i.expression,t,o))return!0;if(_typescript.default.isBlock(i)&&isNonspecificChildBlock(i,t,o))return!0;if(_typescript.default.isExpressionStatement(i)&&_typescript.default.isCallExpression(i.expression)&&!isForEachComponent(i.expression)&&isComponent(i.expression,o)){var r=isNonspecificChildNonForEach(i.expression,t);if(r)return r;s+1<n&&_typescript.default.isBlock(e.statements[s+1])&&++s}}return!1}function isNonspecificChildIf(e,t,o){return isNonspecificChildIfStatement(e.thenStatement,t,o)||isNonspecificChildIfStatement(e.elseStatement,t,o)}function isNonspecificChildForEach(e,t,o){if(_typescript.default.isCallExpression(e)&&e.arguments&&e.arguments.length>1&&_typescript.default.isArrowFunction(e.arguments[1])){var n=e.arguments[1].body;if(!n)return!1;if(_typescript.default.isBlock(n)&&isNonspecificChildBlock(n,t,o))return!0;if(_typescript.default.isIfStatement(n)&&isNonspecificChildIf(n,t,o))return!0;if(_typescript.default.isCallExpression(n)&&isForEachComponent(n)&&isNonspecificChildForEach(n,t,o))return!0;if(_typescript.default.isCallExpression(n)&&!isForEachComponent(n)&&isComponent(n,o)&&isNonspecificChildNonForEach(n,t))return!0}return!1}function isNonspecificChildNonForEach(e,t){return!(!_typescript.default.isIdentifier(e.expression)||t.has(e.expression.escapedText.toString()))}function isNonspecificChildIfStatement(e,t,o){return!!e&&(!(!_typescript.default.isBlock(e)||!isNonspecificChildBlock(e,t,o))||(!(!_typescript.default.isIfStatement(e)||!isNonspecificChildIf(e,t,o))||(!!(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&isForEachComponent(e.expression)&&isNonspecificChildForEach(e.expression,t,o))||!!(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&!isForEachComponent(e.expression)&&isComponent(e.expression,o)&&isNonspecificChildNonForEach(e.expression,t)))))}function collectComponentProps(e){var t=e.name.getText(),o=getComponentSet(e);propertyCollection.set(t,o.propertys),stateCollection.set(t,o.states),linkCollection.set(t,o.links),propCollection.set(t,o.props),regularCollection.set(t,o.regulars),storagePropCollection.set(t,o.storageProps),storageLinkCollection.set(t,o.storageLinks),provideCollection.set(t,o.provides),consumeCollection.set(t,o.consumes),objectLinkCollection.set(t,o.objectLinks)}function getComponentSet(e){var t=new Set,o=new Set,n=new Set,s=new Set,i=new Set,r=new Set,a=new Set,c=new Set,p=new Set,l=new Set;return traversalComponentProps(e,t,i,o,n,s,r,a,c,p,l),{propertys:t,regulars:i,states:o,links:n,props:s,storageProps:r,storageLinks:a,provides:c,consumes:p,objectLinks:l}}function traversalComponentProps(e,t,o,n,s,i,r,a,c,p,l){var u=this,d=!0;if(e.members){var C=new Set;e.members.forEach(function(e){if(_newArrowCheck(this,u),_typescript.default.isPropertyDeclaration(e)&&_typescript.default.isIdentifier(e.name)){var _=e.name.getText();if(t.add(_),e.decorators&&e.decorators.length){d=!1;for(var f=0;f<e.decorators.length;f++){var m=e.decorators[f].getText().replace(/\(.*\)$/,"").trim();_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(m)&&(dollarCollection.add("$"+_),collectionStates(m,_,n,s,i,r,a,c,p,l))}}else o.add(_)}_typescript.default.isMethodDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name)&&C.add(e.name.getText())}.bind(this)),classMethodCollection.set(e.name.getText(),C)}isStaticViewCollection.set(e.name.getText(),d)}function collectionStates(e,t,o,n,s,i,r,a,c,p){switch(e){case _pre_define.COMPONENT_STATE_DECORATOR:o.add(t);break;case _pre_define.COMPONENT_LINK_DECORATOR:n.add(t);break;case _pre_define.COMPONENT_PROP_DECORATOR:s.add(t);break;case _pre_define.COMPONENT_STORAGE_PROP_DECORATOR:i.add(t);break;case _pre_define.COMPONENT_STORAGE_LINK_DECORATOR:r.add(t);break;case _pre_define.COMPONENT_PROVIDE_DECORATOR:a.add(t);break;case _pre_define.COMPONENT_CONSUME_DECORATOR:c.add(t);break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:p.add(t)}}function sourceReplace(e){var t=this,o=e;return o=processSystemApi(o=preprocessNewExtend(o=preprocessExtend(o=o.replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b.+\\{","g"),function(e){return _newArrowCheck(this,t),e=e.replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b","g"),"".concat(_pre_define.CLASS," ")),"".concat(e," constructor(").concat(_pre_define.COMPONENT_CONSTRUCTOR_ID,"?, ").concat(_pre_define.COMPONENT_CONSTRUCTOR_PARENT,"?, ").concat(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS,"?) {}")}.bind(this)))))}function preprocessExtend(e){var t=this;return e.replace(/(?<![\*|\/]\s*)^(\s*)@Extend(\s+)(\S+)\.(\S+)(\s*\()(.*)(\)\s*{)/gm,function(e,o,n,s,i,r,a,c){return _newArrowCheck(this,t),collectExtend(s,i,a),"".concat(o).concat(_pre_define.COMPONENT_EXTEND_DECORATOR," function").concat(n,"__").concat(s,"__").concat(i).concat(r).concat(a).concat(c).concat(s)}.bind(this))}function preprocessNewExtend(e){var t=this;return e.replace(/(?<![\*|\/]\s*)^(\s*)@Extend\s*\((.+)\)(\s+)function(\s+)(\S+)(\s*\()(.*)(\)\s*{)/gm,function(e,o,n,s,i,r,a,c,p){return _newArrowCheck(this,t),collectExtend(n,r,c),"".concat(o).concat(_pre_define.COMPONENT_EXTEND_DECORATOR).concat(s,"function").concat(i,"__").concat(n,"__").concat(r).concat(a).concat(c).concat(p).concat(n)}.bind(this))}function collectExtend(e,t,o){var n;n=o?o.split(",").length:0,_component_map.BUILDIN_STYLE_NAMES.add(t),_component_map.EXTEND_ATTRIBUTE.has(e)?_component_map.EXTEND_ATTRIBUTE.get(e).add({attribute:t,parameterCount:n}):_component_map.EXTEND_ATTRIBUTE.set(e,new Set([{attribute:t,parameterCount:n}]))}function processSystemApi(e){var t=this;return e.replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,o,n,s,i){_newArrowCheck(this,t);var r=n||i;return"var ".concat(o||s,' = globalThis.requireNapi("').concat(r,'", true);')}.bind(this)).replace(/import\s+(.+)\s+from\s+['"]@(system|ohos)\.(\S+)['"]|import\s+(.+)\s*=\s*require\(\s*['"]@(system|ohos)\.(\S+)['"]\s*\)/g,function(e,o,n,s,i,r,a){_newArrowCheck(this,t);var c=n||r,p=s||a,l=o||i;return moduleCollection.add("".concat(c,".").concat(p)),_pre_define.NATIVE_MODULE.has("".concat(c,".").concat(p))?e="var ".concat(l," = globalThis.requireNativeModule('").concat(c,".").concat(p,"')"):c===_pre_define.SYSTEM_PLUGIN?e="var ".concat(l," = isSystemplugin('").concat(p,"', '").concat(_pre_define.SYSTEM_PLUGIN,"') ? ")+"globalThis.systemplugin.".concat(p," : globalThis.requireNapi('").concat(p,"')"):c===_pre_define.OHOS_PLUGIN&&(e="var ".concat(l," = isSystemplugin('").concat(p,"', '").concat(_pre_define.OHOS_PLUGIN,"') ? ")+"globalThis.ohosplugin.".concat(p," : isSystemplugin('").concat(p,"', '").concat(_pre_define.SYSTEM_PLUGIN,"') ? ")+"globalThis.systemplugin.".concat(p," : globalThis.requireNapi('").concat(p,"')")),e}.bind(this))}function resetComponentCollection(){componentCollection.entryComponent=null,componentCollection.previewComponent=null}exports.moduleCollection=moduleCollection;
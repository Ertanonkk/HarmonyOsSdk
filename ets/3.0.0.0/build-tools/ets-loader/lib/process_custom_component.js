"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processCustomComponent=processCustomComponent;var _typescript=_interopRequireDefault(require("typescript")),_pre_define=require("./pre_define"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_member=require("./process_component_member"),_utils=require("./utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,c=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){c=!0,n=e},f:function(){try{o||null==r.return||r.return()}finally{if(c)throw n}}}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}var localArray=[].concat(_toConsumableArray(_process_component_member.observedPropertyDecorators),[_pre_define.COMPONENT_NON_DECORATOR,_pre_define.COMPONENT_PROP_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR]),decoractorMap=new Map([[_pre_define.COMPONENT_STATE_DECORATOR,_validate_ui_syntax.stateCollection],[_pre_define.COMPONENT_LINK_DECORATOR,_validate_ui_syntax.linkCollection],[_pre_define.COMPONENT_PROP_DECORATOR,_validate_ui_syntax.propCollection],[_pre_define.COMPONENT_NON_DECORATOR,_validate_ui_syntax.regularCollection],[_pre_define.COMPONENT_PROVIDE_DECORATOR,_validate_ui_syntax.provideCollection],[_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_validate_ui_syntax.objectLinkCollection]]);function processCustomComponent(e,t,r){_typescript.default.isCallExpression(e.expression)&&addCustomComponent(e,t,(0,_process_component_member.createCustomComponentNewExpression)(e.expression),r)}function addCustomComponent(e,t,r,a){if(_typescript.default.isNewExpression(r)){var i=getCustomComponentName(r),n=[];validateCustomComponentPrams(e,i,n,a),addCustomComponentStatements(e,t,r,i,n)}}function addCustomComponentStatements(e,t,r,a,i){var n=_utils.componentInfo.id.toString();t.push(createFindChildById(n),createCustomComponentIfStatement(n,_typescript.default.factory.updateExpressionStatement(e,(0,_process_component_member.createViewCreate)(r)),_typescript.default.factory.createObjectLiteralExpression(i,!0),a))}function validateCustomComponentPrams(e,t,r,a){var i=this,n=new Set([]),o=e.expression.arguments,c=getCollectionSet(t,_validate_ui_syntax.propertyCollection),s=getCollectionSet(t,_validate_ui_syntax.linkCollection);o&&1===o.length&&_typescript.default.isObjectLiteralExpression(o[0])&&o[0].properties.forEach(function(e){_newArrowCheck(this,i),n.add(e.name.getText()),isThisProperty(e,c)?(validateStateManagement(e,t,a),isNonThisProperty(e,s)&&r.push(e)):validateNonExistentProperty(e,t,a)}.bind(this));validateMandatoryToInitViaParam(e,t,n,a)}function getCustomComponentName(e){var t;return _typescript.default.isIdentifier(e.expression)?t=e.expression.escapedText.toString():_typescript.default.isPropertyAccessExpression(e.expression)&&(t=e.expression.name.escapedText.toString()),t}function getCollectionSet(e,t){return t.get(e)||new Set([])}function isThisProperty(e,t){return!!(_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.name)&&t.has(e.name.escapedText.toString()))}function isNonThisProperty(e,t){return!(!_typescript.default.isPropertyAssignment(e)||!_typescript.default.isIdentifier(e.name)||t.has(e.name.escapedText.toString()))}function validateStateManagement(e,t,r){validateForbiddenToInitViaParam(e,t,r),checkFromParentToChild(e,t,r)}function checkFromParentToChild(e,t,r){var a=e.name.getText(),i=getPropertyDecoratorKind(a,t);if(i)if(isInitFromParent(e)){var n=getParentPropertyName(e,i,r);if(!n)return;var o=_process_component_member.curPropMap.get(n);o&&!isCorrectInitFormParent(o,i)&&validateIllegalInitFromParent(e,a,i,n,o,r)}else isInitFromLocal(e)&&_typescript.default.isPropertyAssignment(e)&&(localArray.includes(i)||validateIllegalInitFromParent(e,a,i,e.initializer.getText(),_pre_define.COMPONENT_NON_DECORATOR,r))}function isInitFromParent(e){if(_typescript.default.isPropertyAssignment(e)&&e.initializer){if(_typescript.default.isPropertyAccessExpression(e.initializer)&&e.initializer.expression&&e.initializer.expression.kind===_typescript.default.SyntaxKind.ThisKeyword&&_typescript.default.isIdentifier(e.initializer.name))return!0;if(_typescript.default.isIdentifier(e.initializer)&&matchStartWithDollar(e.initializer.getText()))return!0}}function isInitFromLocal(e){if(_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.initializer)&&!matchStartWithDollar(e.initializer.getText()))return!0}function getParentPropertyName(e,t,r){var a,i=e.initializer;t===_pre_define.COMPONENT_LINK_DECORATOR?hasDollar(i)?a=(i.name||i).getText().replace(/^\$/,""):validateLinkWithoutDollar(e,r):hasDollar(i)?validateNonLinkWithDollar(e,r):a=e.initializer.name.getText();return a}function isCorrectInitFormParent(e,t){switch(t){case _pre_define.COMPONENT_STATE_DECORATOR:case _pre_define.COMPONENT_PROVIDE_DECORATOR:if(e===_pre_define.COMPONENT_NON_DECORATOR)return!0;break;case _pre_define.COMPONENT_LINK_DECORATOR:if([_pre_define.COMPONENT_STATE_DECORATOR,_pre_define.COMPONENT_LINK_DECORATOR,_pre_define.COMPONENT_STORAGE_LINK_DECORATOR].includes(e))return!0;break;case _pre_define.COMPONENT_PROP_DECORATOR:if([_pre_define.COMPONENT_STATE_DECORATOR].concat(_toConsumableArray(_process_component_member.propAndLinkDecorators)).includes(e))return!0;break;case _pre_define.COMPONENT_NON_DECORATOR:if([_pre_define.COMPONENT_STATE_DECORATOR].concat(_toConsumableArray(_process_component_member.propAndLinkDecorators),[_pre_define.COMPONENT_NON_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR]).includes(e))return!0;break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:if(e===_pre_define.COMPONENT_STATE_DECORATOR)return!0}return!1}function getPropertyDecoratorKind(e,t){var r,a=_createForOfIteratorHelper(decoractorMap.entries());try{for(a.s();!(r=a.n()).done;){var i=r.value;if(getCollectionSet(t,i[1]).has(e))return i[0]}}catch(e){a.e(e)}finally{a.f()}}function createFindChildById(e){return _typescript.default.factory.createVariableStatement(void 0,_typescript.default.factory.createVariableDeclarationList([_typescript.default.factory.createVariableDeclaration(_typescript.default.factory.createIdentifier("".concat(_pre_define.CUSTOM_COMPONENT_EARLIER_CREATE_CHILD).concat(e)),void 0,void 0,_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier("".concat(_pre_define.CUSTOM_COMPONENT_FUNCTION_FIND_CHILD_BY_ID))),void 0,[_typescript.default.factory.createStringLiteral(e)]))],_typescript.default.NodeFlags.Let))}function createCustomComponentIfStatement(e,t,r,a){var i="".concat(_pre_define.CUSTOM_COMPONENT_EARLIER_CREATE_CHILD).concat(e);return _typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(i),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsToken),_typescript.default.factory.createIdentifier("".concat(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED))),_typescript.default.factory.createBlock([t],!0),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(i),_typescript.default.factory.createIdentifier("".concat(_pre_define.COMPONENT_CONSTRUCTOR_UPDATE_PARAMS))),void 0,[r])),_validate_ui_syntax.isStaticViewCollection.get(a)?createStaticIf(i):void 0,_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier("".concat(_pre_define.BASE_COMPONENT_NAME)),_typescript.default.factory.createIdentifier("".concat(_pre_define.COMPONENT_CREATE_FUNCTION))),void 0,[_typescript.default.factory.createIdentifier(i)]))],!0))}function createStaticIf(e){return _typescript.default.factory.createIfStatement(_typescript.default.factory.createPrefixUnaryExpression(_typescript.default.SyntaxKind.ExclamationToken,_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_NEEDS_UPDATE_FUNCTION)),void 0,[])),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_MARK_STATIC_FUNCTION)),void 0,[]))],!0),void 0)}function hasDollar(e){return!(!_typescript.default.isPropertyAccessExpression(e)||!matchStartWithDollar(e.name.getText()))||!(!_typescript.default.isIdentifier(e)||!matchStartWithDollar(e.getText()))}function matchStartWithDollar(e){return/^\$/.test(e)}function validateForbiddenToInitViaParam(e,t,r){isThisProperty(e,new Set([].concat(_toConsumableArray(getCollectionSet(t,_validate_ui_syntax.storageLinkCollection)),_toConsumableArray(getCollectionSet(t,_validate_ui_syntax.storagePropCollection)),_toConsumableArray(getCollectionSet(t,_validate_ui_syntax.consumeCollection)))))&&r.push({type:_utils.LogType.ERROR,message:"Property '".concat(e.name.getText(),"' in the custom component '").concat(t,"'")+" cannot initialize here (forbidden to specify).",pos:e.name.getStart()})}function validateNonExistentProperty(e,t,r){r.push({type:_utils.LogType.ERROR,message:"Property '".concat(e.name.getText(),"' does not exist on type '").concat(t,"'."),pos:e.name.getStart()})}function validateMandatoryToInitViaParam(e,t,r,a){var i=this;new Set([].concat(_toConsumableArray(getCollectionSet(t,_validate_ui_syntax.propCollection)),_toConsumableArray(getCollectionSet(t,_validate_ui_syntax.linkCollection)),_toConsumableArray(getCollectionSet(t,_validate_ui_syntax.objectLinkCollection)))).forEach(function(n){_newArrowCheck(this,i),r.has(n)||a.push({type:_utils.LogType.ERROR,message:"Property '".concat(n,"' in the custom component '").concat(t,"'")+" is missing (mandatory to specify).",pos:e.getStart()})}.bind(this))}function validateIllegalInitFromParent(e,t,r,a,i,n){n.push({type:_utils.LogType.ERROR,message:"The ".concat(i," property '").concat(a,"' cannot be assigned to ")+"the ".concat(r," property '").concat(t,"'."),pos:e.initializer.getStart()})}function validateLinkWithoutDollar(e,t){t.push({type:_utils.LogType.ERROR,message:"The @Link property '".concat(e.name.getText(),"' should initialize")+" using '$' to create a reference to a @State or @Link variable.",pos:e.initializer.getStart()})}function validateNonLinkWithDollar(e,t){t.push({type:_utils.LogType.ERROR,message:"Property '".concat(e.name.getText(),"' cannot initialize")+" using '$' to create a reference to a variable.",pos:e.initializer.getStart()})}
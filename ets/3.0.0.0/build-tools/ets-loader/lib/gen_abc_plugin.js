"use strict";function _typeof(e){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenAbcPlugin=void 0;var process=_interopRequireWildcard(require("child_process")),fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),_compile_info=require("./compile_info");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache();if(r&&r.has(e))return r.get(e);var t={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var o=i?Object.getOwnPropertyDescriptor(e,n):null;o&&(o.get||o.set)?Object.defineProperty(t,n,o):t[n]=e[n]}return t.default=e,r&&r.set(e,t),t}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}var output,webpackPath,arkDir=path.join(__dirname,"..","bin","ark"),firstFileEXT="_.js",isWin=!1,isMac=!1,isDebug=!1,red="[31m",blue="[34m",reset="[39m",GenAbcPlugin=function(){function e(r,t,i){_classCallCheck(this,e),output=r,webpackPath=t,isDebug=i}return _createClass(e,[{key:"apply",value:function(e){var r=this;if(fs.existsSync(path.resolve(webpackPath,"ark/build-win")))isWin=!0;else if(fs.existsSync(path.resolve(webpackPath,"ark/build-mac")))isMac=!0;else if(!fs.existsSync(path.resolve(webpackPath,"ark/build")))return void _compile_info.logger.error(red,"ETS:ERROR find build fail",reset);e.hooks.emit.tap("GenAbcPlugin",function(e){var t=this;_newArrowCheck(this,r),Object.keys(e.assets).forEach(function(r){if(_newArrowCheck(this,t),output&&webpackPath&&".js"===path.extname(r)){var i=e.assets[r].source(),n=r.replace(/\.js$/,firstFileEXT);writeFileSync(i,path.resolve(output,n),r)}}.bind(this))}.bind(this))}}]),e}();function writeFileSync(e,r,t){var i=path.join(r,"..");fs.existsSync(i)&&fs.statSync(i).isDirectory()||mkDir(i),fs.writeFileSync(r,e),fs.existsSync(r)?js2abcFirst(r):_compile_info.logger.error(red,"ETS:ERROR Failed to convert file ".concat(t," to bin. ").concat(r," is lost"),reset)}function mkDir(e){var r=path.join(e,"..");fs.existsSync(r)&&!fs.statSync(r).isFile()||mkDir(r),fs.mkdirSync(e)}function js2abcFirst(e){var r="-r";isDebug&&(r+=" --debug");var t=path.join(arkDir,"build","src","index.js");isWin?t=path.join(arkDir,"build-win","src","index.js"):isMac&&(t=path.join(arkDir,"build-mac","src","index.js"));var i='node --expose-gc "'.concat(t,'" "').concat(e,'" ').concat(r);try{_compile_info.logger.info(blue,"ETS:INFO ".concat(i),reset,"\n"),process.execSync(i)}catch(r){return void _compile_info.logger.error(red,"ETS:ERROR Failed to convert file ".concat(e," to abc "),reset)}fs.existsSync(e)&&fs.unlinkSync(e);var n=e.replace(/\.js$/,".abc");if(fs.existsSync(n)){var o=n.replace(/_.abc$/,".abc");fs.renameSync(n,o)}else _compile_info.logger.error(red,"ETS:ERROR ".concat(n," is lost"),reset)}exports.GenAbcPlugin=GenAbcPlugin;
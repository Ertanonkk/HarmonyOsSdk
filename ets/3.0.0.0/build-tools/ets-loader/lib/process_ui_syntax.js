"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processUISyntax=processUISyntax,exports.resetLog=resetLog,exports.transformLog=void 0;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_class=require("./process_component_class"),_process_import=_interopRequireDefault(require("./process_import")),_pre_define=require("./pre_define"),_utils=require("./utils"),_process_component_build=require("./process_component_build"),_component_map=require("./component_map"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw a}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}var transformLog=new _utils.FileLog;function processUISyntax(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(n){var o,a=this;return _newArrowCheck(this,t),function(t){return _newArrowCheck(this,a),o=_path.default.resolve(_path.default.dirname(t.fileName)),process.env.compiler===_pre_define.BUILD_ON?r||"app.ets.ts"!==_path.default.basename(t.fileName)&&/\.ets\.ts$/.test(t.fileName)?(collectComponents(t),transformLog.sourceFile=t,function(t){e&&(t=_typescript.default.visitEachChild(t,p,n))}(t),t=createEntryNode(t,n),t=_typescript.default.visitEachChild(t,i,n)):t=_typescript.default.visitEachChild(t,s,n):t}.bind(this);function i(t){return _typescript.default.isImportDeclaration(t)||_typescript.default.isImportEqualsDeclaration(t)?(0,_process_import.default)(t,o,transformLog.errors):_typescript.default.isClassDeclaration(t)&&t.name&&_validate_ui_syntax.componentCollection.customComponents.has(t.name.getText())?(_validate_ui_syntax.componentCollection.currentClassName=t.name.getText(),t=(0,_process_component_class.processComponentClass)(t,n,transformLog.errors,e),_validate_ui_syntax.componentCollection.currentClassName=null):_typescript.default.isFunctionDeclaration(t)?(0,_utils.hasDecorator)(t,_pre_define.COMPONENT_EXTEND_DECORATOR)?t=processExtend(t,transformLog.errors):(0,_utils.hasDecorator)(t,_pre_define.COMPONENT_BUILDER_DECORATOR)&&t.name&&t.body&&_typescript.default.isBlock(t.body)&&(_component_map.CUSTOM_BUILDER_METHOD.add(t.name.getText()),t=_typescript.default.factory.updateFunctionDeclaration(t,void 0,t.modifiers,t.asteriskToken,t.name,t.typeParameters,t.parameters,t.type,(0,_process_component_build.processComponentBlock)(t.body,!1,transformLog.errors))):isResource(t)?t=processResourceData(t):isWorker(t)&&(t=processWorker(t)),_typescript.default.visitEachChild(t,i,n)}function s(e){return isResource(e)&&(e=processResourceData(e)),_typescript.default.visitEachChild(e,s,n)}function p(t){if(_typescript.default.isMethodDeclaration(t)&&t.name&&t.name.getText()===_pre_define.COMPONENT_BUILD_FUNCTION&&t.body&&_typescript.default.isBlock(t.body)){var r=e.getTypeChecker();return validateBody(t.body,r),t}return _typescript.default.visitEachChild(t,p,n)}}.bind(this)}function collectComponents(e){if(e.identifiers&&e.identifiers.size){var t,r=_createForOfIteratorHelper(e.identifiers.keys());try{for(r.s();!(t=r.n()).done;){var n=t.value;_component_map.JS_BIND_COMPONENTS.has(n)&&_process_component_build.appComponentCollection.add(n)}}catch(e){r.e(e)}finally{r.f()}}}function isResource(e){return _typescript.default.isCallExpression(e)&&_typescript.default.isIdentifier(e.expression)&&(e.expression.escapedText.toString()===_pre_define.RESOURCE||e.expression.escapedText.toString()===_pre_define.RESOURCE_RAWFILE)&&e.arguments.length>0}function processResourceData(e){if(_typescript.default.isStringLiteral(e.arguments[0])){if(e.expression.getText()===_pre_define.RESOURCE_RAWFILE)return createResourceParam(0,_pre_define.RESOURCE_TYPE.rawfile,[e.arguments[0]]);var t=e.arguments[0].text.trim().split(".");if(validateResourceData(t,_main.resources,e.arguments[0].getStart())){var r=_pre_define.RESOURCE_TYPE[t[1]];return createResourceParam(_main.resources[t[0]][t[1]][t[2]],r,Array.from(e.arguments).slice(1))}}return e}function createResourceParam(e,t,r){return _typescript.default.factory.createObjectLiteralExpression([_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createStringLiteral(_pre_define.RESOURCE_NAME_ID),_typescript.default.factory.createNumericLiteral(e)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createStringLiteral(_pre_define.RESOURCE_NAME_TYPE),_typescript.default.factory.createNumericLiteral(t)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier(_pre_define.RESOURCE_NAME_PARAMS),_typescript.default.factory.createArrayLiteralExpression(r,!1))],!1)}function validateResourceData(e,t,r){if(3!==e.length)transformLog.errors.push({type:_utils.LogType.ERROR,message:"The input parameter is not supported.",pos:r});else if(t[e[0]])if(t[e[0]][e[1]]){if(t[e[0]][e[1]][e[2]])return!0;transformLog.errors.push({type:_utils.LogType.ERROR,message:"Value '".concat(e[2],"' does not exist on type 'typeof ").concat(e[1],"'."),pos:r})}else transformLog.errors.push({type:_utils.LogType.ERROR,message:"Value '".concat(e[1],"' does not exist on type 'typeof ").concat(e[0],"'."),pos:r});else transformLog.errors.push({type:_utils.LogType.ERROR,message:"The value of '".concat(e[0],"' is invalid."),pos:r});return!1}function isWorker(e){return _typescript.default.isNewExpression(e)&&_typescript.default.isPropertyAccessExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.name)&&e.expression.name.escapedText.toString()===_pre_define.WORKER_OBJECT}function processWorker(e){if(e.arguments.length&&_typescript.default.isStringLiteral(e.arguments[0])){var t=Array.from(e.arguments),r=e.arguments[0].text,n=_typescript.default.factory.createStringLiteral(r.replace(/\.ts$/,".js"));return t.splice(0,1,n),_typescript.default.factory.updateNewExpression(e,e.expression,e.typeArguments,t)}return e}function processExtend(e,t){var r=isExtendFunction(e);if(r){var n=[];return(0,_process_component_build.bindComponentAttr)(e.body.statements[0],_typescript.default.factory.createIdentifier(r),n,t),_typescript.default.factory.updateFunctionDeclaration(e,void 0,e.modifiers,e.asteriskToken,e.name,e.typeParameters,e.parameters,e.type,_typescript.default.factory.updateBlock(e.body,n))}}function isExtendFunction(e){var t=this;if(_typescript.default.isBlock(e.body)&&e.body.statements&&1===e.body.statements.length&&_typescript.default.isExpressionStatement(e.body.statements[0])&&_typescript.default.isCallExpression(e.body.statements[0].expression)&&_typescript.default.isIdentifier(e.name)){var r=e.name.getText().split("__");if(3===r.length&&!r[0]&&_component_map.EXTEND_ATTRIBUTE.has(r[1]))if(_toConsumableArray(_component_map.EXTEND_ATTRIBUTE.get(r[1])).map(function(e){return _newArrowCheck(this,t),e.attribute}.bind(this)).includes(r[2]))return r[1]}}function createEntryNode(e,t){if(_validate_ui_syntax.componentCollection.entryComponent&&!_validate_ui_syntax.componentCollection.previewComponent){var r=createEntryFunction(_validate_ui_syntax.componentCollection.entryComponent,t);return t.factory.updateSourceFile(e,[].concat(_toConsumableArray(e.statements),[r]))}if(_validate_ui_syntax.componentCollection.entryComponent&&_validate_ui_syntax.componentCollection.previewComponent){var n=createEntryFunction(_validate_ui_syntax.componentCollection.previewComponent,t);return t.factory.updateSourceFile(e,[].concat(_toConsumableArray(e.statements),[n]))}return e}function validateBody(e,t){var r=this;e.statements.length&&e.statements.forEach(function(e,n,o){if(_newArrowCheck(this,r),_typescript.default.isBlock(e)&&validateBody(e,t),n+2<o.length&&_typescript.default.isExpressionStatement(e)&&isAttributeBlockNode(e,o,n)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression))for(var a,i=e.expression.expression.getText(),s=t.getTypeAtLocation(e.expression),p=o[n+2];p;){if(_typescript.default.isCallExpression(p))if(_typescript.default.isPropertyAccessExpression(p.expression)){var c=p.expression.name.getStart();a=p.expression.name.getText(),validateSymbol(isPropertyExist(t,c,s,a,i),p.arguments,c,t)}else if(_typescript.default.isIdentifier(p.expression)){var u=p.expression.getStart();a=p.expression.getText(),validateSymbol(isPropertyExist(t,u,s,a,i),p.arguments,u,t);break}p=p.expression}}.bind(this))}function validateSymbol(e,t,r,n){if(e&&e.valueDeclaration.parameters){var o,a=e.valueDeclaration.parameters,i=a.length,s=getMinLength(a);if(t.length<s||t.length>i)o=i!==s?"TS2554: Expected ".concat(s,"-").concat(i," arguments, but got ").concat(t.length,"."):"TS2554: Expected ".concat(i," arguments, but got ").concat(t.length,"."),transformLog.errors.push({type:_utils.LogType.ERROR,message:o,pos:r});else for(var p=0;p<a.length;p++)validatePropertyType(a[p],t[p],n)}}function getMinLength(e){var t=this,r=e.length;return e.forEach(function(e){_newArrowCheck(this,t),void 0!==e.questionToken&&r--}.bind(this)),r}function isPropertyExist(e,t,r,n,o){var a=e.getPropertyOfType(r,n);return a||(transformLog.errors.push({type:_utils.LogType.ERROR,message:"TS2339: Property '".concat(n,"' does not exist on type '").concat(o,"'."),pos:t}),null)}function validatePropertyType(e,t,r){var n=r.getTypeAtLocation(t),o=r.getTypeAtLocation(e.type),a=r.getBaseTypeOfLiteralType(r.getTypeAtLocation(t)).intrinsicName||r.typeToString(n);r.isTypeAssignableTo(n,o)||generateArgumentLog(t,a,r.typeToString(o))}function generateArgumentLog(e,t,r){transformLog.errors.push({type:_utils.LogType.ERROR,message:"TS2345: Argument of type '".concat(t,"' is not assignable to parameter of type '").concat(r,"'."),pos:e.getStart()})}function isAttributeBlockNode(e,t,r){var n=t[r+2];return _component_map.BUILDIN_CONTAINER_COMPONENT.has((0,_process_component_build.getName)(e))&&_typescript.default.isBlock(t[r+1])&&_typescript.default.isExpressionStatement(n)&&(0,_process_component_build.isAttributeNode)(n)}function createEntryFunction(e,t){return t.factory.createExpressionStatement(t.factory.createCallExpression(t.factory.createIdentifier(_pre_define.PAGE_ENTRY_FUNCTION_NAME),void 0,[t.factory.createNewExpression(t.factory.createIdentifier(e),void 0,[t.factory.createStringLiteral((++_utils.componentInfo.id).toString()),t.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED),t.factory.createObjectLiteralExpression([],!1)])]))}function resetLog(){transformLog.errors=[]}exports.transformLog=transformLog;
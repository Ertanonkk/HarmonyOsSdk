"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ResultStates=exports.logger=void 0;var _log4js=require("log4js"),_RawSource=_interopRequireDefault(require("webpack-sources/lib/RawSource")),_component_map=require("./component_map"),_process_ui_syntax=require("./process_ui_syntax"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_member=require("./process_component_member"),_process_component_build=require("./process_component_build"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}(0,_log4js.configure)({appenders:{ETS:{type:"stderr",layout:{type:"messagePassThrough"}}},categories:{default:{appenders:["ETS"],level:"info"}}});var logger=(0,_log4js.getLogger)("ETS");exports.logger=logger;var props=[],ResultStates=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"mStats",void 0),_defineProperty(this,"mErrorCount",0),_defineProperty(this,"mWarningCount",0),_defineProperty(this,"warningCount",0),_defineProperty(this,"noteCount",0),_defineProperty(this,"red","[31m"),_defineProperty(this,"yellow","[33m"),_defineProperty(this,"blue","[34m"),_defineProperty(this,"reset","[39m")}return _createClass(e,[{key:"apply",value:function(e){var t=this;e.hooks.compilation.tap("SourcemapFixer",function(e){var r=this;_newArrowCheck(this,t),e.hooks.afterProcessAssets.tap("SourcemapFixer",function(e){var t=this;_newArrowCheck(this,r),Reflect.ownKeys(e).forEach(function(r){_newArrowCheck(this,t),/\.map$/.test(r.toString())&&(e[r]._value=e[r]._value.toString().replace(".ets?entry",".ets"))}.bind(this))}.bind(this))}.bind(this)),e.hooks.done.tap("Result States",function(e){_newArrowCheck(this,t),this.mStats=e,this.warningCount=0,this.noteCount=0,this.mStats.compilation.errors&&(this.mErrorCount=this.mStats.compilation.errors.length),this.mStats.compilation.warnings&&(this.mWarningCount=this.mStats.compilation.warnings.length),props.push.apply(props,_toConsumableArray(_validate_ui_syntax.dollarCollection).concat(_toConsumableArray(_process_component_member.decoratorParamSet),_toConsumableArray(_component_map.BUILDIN_STYLE_NAMES))),this.printResult()}.bind(this)),_main.projectConfig.isPreview||e.hooks.compilation.tap("Collect Components And Modules",function(e){var r=this;_newArrowCheck(this,t),e.hooks.additionalAssets.tapAsync("Collect Components And Modules",function(t){_newArrowCheck(this,r),e.assets["./component_collection.txt"]=new _RawSource.default(Array.from(_process_component_build.appComponentCollection).join(",")),e.assets["./module_collection.txt"]=new _RawSource.default(0===_validate_ui_syntax.moduleCollection.size?"NULL":Array.from(_validate_ui_syntax.moduleCollection).join(",")),t()}.bind(this))}.bind(this))}},{key:"printResult",value:function(){if(this.printWarning(),this.printError(),this.mErrorCount+this.warningCount+this.noteCount>0){var e,t="";this.mErrorCount>0?(t+="ERROR:".concat(this.mErrorCount),e="FAIL "):e="SUCCESS ",this.warningCount>0&&(t+=" WARN:".concat(this.warningCount)),this.noteCount>0&&(t+=" NOTE:".concat(this.noteCount)),logger.info(this.blue,"COMPILE RESULT:"+e+"{".concat(t,"}"),this.reset)}else console.info(this.blue,"COMPILE RESULT:SUCCESS ",this.reset)}},{key:"printWarning",value:function(){if(this.mWarningCount>0){for(var e=this.mStats.compilation.warnings,t=e.length,r=0;r<t;r++){var o=e[r].message.replace(/^Module Warning\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"");/^NOTE/.test(o)?(this.noteCount++,logger.info(this.blue,o,this.reset,"\n")):(this.warningCount++,logger.warn(this.yellow,o.replace(/^WARN/,"ETS:WARN"),this.reset,"\n"))}this.mWarningCount>t&&(this.warningCount=this.warningCount+this.mWarningCount-t)}}},{key:"printError",value:function(){if(this.mErrorCount>0)for(var e=_toConsumableArray(this.mStats.compilation.errors),t=0;t<e.length;t++)if(e[t].issue){var r=e[t].issue.location?":".concat(e[t].issue.location.start.line,":").concat(e[t].issue.location.start.column):"",o=e[t].issue.file+r,n=e[t].issue.message;logger.error(this.red,"ETS:ERROR File: "+o,this.reset),logger.error(this.red,n,this.reset,"\n")}else if(/BUILDERROR/.test(e[t].message)){var i=e[t].message.replace(/^Module Error\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"").replace(/^ERROR/,"ETS:ERROR");this.printErrorMessage(i,!0,e[t])}else{var s="".concat(e[t].message.replace(/\[tsl\]\s*/,"").replace(/\u001b\[.*?m/g,"").replace(/\.ets\.ts/g,".ets").trim(),"\n");s=this.filterModuleError(s).replace(/^ERROR in /,"ETS:ERROR File: ").replace(/\s{6}TS/g," TS").replace(/\(([0-9]+),([0-9]+)\)/,":$1:$2"),this.printErrorMessage(s,!1,e[t])}}},{key:"printErrorMessage",value:function(e,t,r){if(this.validateError(e))t?logger.error(this.red,e+"\n",this.reset):logger.error(this.red,e,this.reset);else{var o=this.mStats.compilation.errors.indexOf(r);this.mStats.compilation.errors.splice(o,1),this.mErrorCount=this.mErrorCount-1}}},{key:"validateError",value:function(e){return!(this.matchMessage(e,props,/Cannot find name\s*'(\$?[_a-zA-Z0-9]+)'/)||this.matchMessage(e,_toConsumableArray(_validate_ui_syntax.componentCollection.customComponents),/'typeof\s*(\$?[_a-zA-Z0-9]+)' is not callable/)||this.matchMessage(e,props,/Property\s*'(\$[_a-zA-Z0-9]+)' does not exist on type/)||this.matchMessage(e,_component_map.EXTEND_ATTRIBUTE,/Property\s*'([_a-zA-Z0-9]+)' does not exist on type\s*'([_a-zA-Z0-9]+)'\./,!0))}},{key:"matchMessage",value:function(e,t,r){var o=this,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(r.test(e)){var i=e.match(r);if(n){if(i[1]&&i[2]&&t.has(i[2]))if(_toConsumableArray(t.get(i[2])).map(function(e){return _newArrowCheck(this,o),e.attribute}.bind(this)).includes(i[1]))return!0}else if(i[1]&&t.includes(i[1]))return!0}return!1}},{key:"filterModuleError",value:function(e){if(/You may need an additional loader/.test(e)&&_process_ui_syntax.transformLog&&_process_ui_syntax.transformLog.sourceFile){var t=_process_ui_syntax.transformLog.sourceFile.fileName.replace(/.ts$/,""),r=e.split("You may need an additional loader to handle the result of these loaders.");r&&r.length>1&&r[1]&&(e="ERROR in ".concat(t,"\n The following syntax is incorrect.").concat(r[1]))}return e}}]),e}();exports.ResultStates=ResultStates;
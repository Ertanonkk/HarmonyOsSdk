"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fs=require("fs"),path=require("path"),SingleEntryPlugin=require("webpack/lib/SingleEntryPlugin"),CUSTOM_THEME_PROP_GROUPS=require("./theme/customThemeStyles"),OHOS_THEME_PROP_GROUPS=require("./theme/ohosStyles"),FILE_EXT_NAME=[".js",".css",".jsx",".less",".sass",".scss",".md",".DS_Store",".hml"],red="[31m",reset="[39m",input="",output="",manifestFilePath="",shareThemePath="",internalThemePath="";function copyFile(e,t){try{if(fs.existsSync(e)){var r=path.join(t,"..");fs.existsSync(r)&&fs.statSync(r).isDirectory()||mkDir(r);var i=path.parse(e),s=addPageEntryObj(),n=i.dir+path.sep+i.name+".hml?entry";for(var a in s)if(s[a]===n)return;if(".json"===i.ext&&(i.dir===shareThemePath||i.dir===internalThemePath)&&themeFileBuild(e,t))return;var o=fs.createReadStream(e),l=fs.createWriteStream(t);o.pipe(l),o.on("close",function(){l.end()})}}catch(t){throw console.error(red,"Failed to build file ".concat(e,"."),reset),t.message}}function mkDir(e){var t=path.join(e,"..");fs.existsSync(t)&&!fs.statSync(t).isFile()||mkDir(t),fs.mkdirSync(e)}function circularFile(e,t,r){var i=path.join(e,r),s=path.join(input,"i18n");fs.existsSync(i)&&i!==output&&i!==s&&fs.readdirSync(i).forEach(function(s){var n=path.join(i,s),a=fs.statSync(n);if(a.isFile()){var o=path.basename(n),l=path.extname(n);if(FILE_EXT_NAME.indexOf(l)<0&&".DS_Store"!==o){var c=path.join(t,r,path.basename(s));if(c===path.join(output,"manifest.json"))return;if(fs.existsSync(c)){var u=fs.statSync(c);u.isFile()&&a.size!==u.size&&copyFile(n,c)}else copyFile(n,c)}}else a.isDirectory()&&circularFile(e,t,path.join(r,s))})}var ResourcePlugin=function(){function e(t,r,i){(0,_classCallCheck2.default)(this,e),input=t,output=r,manifestFilePath=i,shareThemePath=path.join(t,"../share/resources/styles"),internalThemePath=path.join(t,"resources/styles")}return(0,_createClass2.default)(e,[{key:"apply",value:function(e){var t=this;e.hooks.beforeCompile.tap("resource Copy",function(){(0,_newArrowCheck2.default)(this,t),circularFile(input,output,""),circularFile(input,output,"../share")}.bind(this)),e.hooks.normalModuleFactory.tap("OtherEntryOptionPlugin",function(){if((0,_newArrowCheck2.default)(this,t),"card"!==process.env.DEVICE_LEVEL)for(var r in addPageEntryObj(),entryObj){if(!e.options.entry[r])new SingleEntryPlugin("",entryObj[r],r).apply(e)}}.bind(this)),e.hooks.done.tap("copyManifest",function(){(0,_newArrowCheck2.default)(this,t),copyManifest(),fs.existsSync(path.join(output,"app.js"))&&fs.utimesSync(path.join(output,"app.js"),new Date,new Date)}.bind(this))}}]),e}();function copyManifest(){copyFile(manifestFilePath,path.join(output,"manifest.json"))}var entryObj={};function addPageEntryObj(){var e=this;if(entryObj={},"page"===process.env.abilityType){if(!fs.existsSync(manifestFilePath))throw Error("ERROR: missing manifest").message;var t=fs.readFileSync(manifestFilePath).toString(),r=JSON.parse(t).pages;if(void 0===r)throw Error("ERROR: missing pages").message;r.forEach(function(t){(0,_newArrowCheck2.default)(this,e);var r=t,i=path.join(input,r+".hml"),s=process.env.aceSuperVisualPath||"",n=path.join(s,r+".visual"),a=fs.existsSync(i),o=fs.existsSync(n);a&&o?logWarn(this,[{reason:"ERROR: "+r+" cannot both have hml && visual"}]):a?entryObj["./"+t]=i+"?entry":o&&(entryObj["./"+t]=n+"?entry")}.bind(this))}return"true"!==process.env.isPreview&&"rich"===process.env.DEVICE_LEVEL&&loadWorker(entryObj),entryObj}function loadWorker(e){var t=this,r=path.resolve(input,"workers");if(fs.existsSync(r)){var i=[];readFile(r,i),i.forEach(function(i){if((0,_newArrowCheck2.default)(this,t),/\.js$/.test(i)){var s=path.relative(r,i).replace(/\.js$/,"");e["./workers/"+s]=i}}.bind(this))}}function readFile(e,t){var r=this;try{fs.readdirSync(e).forEach(function(i){(0,_newArrowCheck2.default)(this,r);var s=path.join(e,i);fs.statSync(s).isDirectory()?readFile(s,t):t.push(s)}.bind(this))}catch(e){console.error(e.message)}}function themeFileBuild(e,t){if(fs.existsSync(e)){var r=JSON.parse(fs.readFileSync(e)),i={};if(r&&r.style){i.style={};var s=r.style;return Object.keys(s).forEach(function(e){var t=CUSTOM_THEME_PROP_GROUPS[e],r=OHOS_THEME_PROP_GROUPS[e];r?i.style[r]=s[e]:t?i.style[t]=s[e]:i.style[e]=s[e]}),fs.writeFileSync(t,JSON.stringify(i,null,2)),!0}}return!1}module.exports=ResourcePlugin;
"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_util=require("./util"),path=require("path"),transCardArray=require("./templater/bind").transCardArray,ResourceReferenceParsing=require("./resource-reference-script"),REG_EVENT_STRING=/("\s*\$event\..+")|('\s*\$event\..+')/g,REG_EVENT=/\$event\.[\w]+/g,REG_THIS=/this\..*/g;module.exports=function(source){var _this=this;this.cacheable&&this.cacheable();var extName=path.extname(this.resourcePath);if("card"===process.env.DEVICE_LEVEL&&(source=source.replace(/\/\*((\n|\r|.)*?)\*\//gm,""),source=source.replace(/(\s|\;|^|\{|\})\/\/.*$/gm,"$1"),".js"===extName||".json"===extName)){if(0===source.trim().indexOf("export default")&&(source=source.replace("export default","")),source=ResourceReferenceParsing(source),source=source.replace(REG_EVENT_STRING,function(e){return(0,_newArrowCheck2.default)(this,_this),e.slice(1,-1)}.bind(this)),source=source.replace(REG_EVENT,function(e){return(0,_newArrowCheck2.default)(this,_this),'"'+e+'"'}.bind(this)),source=source.replace(REG_THIS,function(e){return(0,_newArrowCheck2.default)(this,_this),'"'!==e.charAt(e.length-1)&&"'"!==e.charAt(e.length-1)&&'",'!==e.slice(-2)&&"',"!==e.slice(-2)&&(e=","===e.charAt(e.length-1)?'"{{'.concat(transCardArray(e.slice(0,-1)),'}}",').replace(/this\./g,""):'"{{'.concat(transCardArray(e),'}}"').replace(/this\./g,"")),e}.bind(this)),".js"!==extName)return source;try{source=JSON.stringify(eval("("+source+")"))}catch(e){return(0,_util.logWarn)(this,[{reason:"ERROR: Failed to parse the file : "+this.resourcePath+"\n".concat(e)}]),"{}"}}return"module.exports = ".concat(source)};
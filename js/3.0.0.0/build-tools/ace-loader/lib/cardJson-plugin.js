"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_util=require("./util"),fs=require("fs"),path=require("path"),_require=require("webpack"),Compilation=_require.Compilation,AfterEmitPlugin=function(){function e(){(0,_classCallCheck2.default)(this,e)}return(0,_createClass2.default)(e,[{key:"apply",value:function(e){var t=this;e.hooks.thisCompilation.tap("card",function(e){var a=this;(0,_newArrowCheck2.default)(this,t),e.hooks.processAssets.tapAsync({name:"MyPlugin",stage:Compilation.PROCESS_ASSETS_STAGE_REPOR},function(t,r){var n=this;(0,_newArrowCheck2.default)(this,a),Object.keys(t).forEach(function(a){(0,_newArrowCheck2.default)(this,n),sourceChange(a,t,e)}.bind(this)),r&&r()}.bind(this))}.bind(this))}}]),e}();function sourceChange(e,t,a){var r=this;try{var n=path.extname(e);if(".js"===n){var s={},o=t[e].source();o.match(/card_start((\s||\S)*)card_end/)[1].split("\n").forEach(function(e){(0,_newArrowCheck2.default)(this,r),elementChange(e,o,s)}.bind(this));var i={};Object.keys(s).forEach(function(t){toAddJson(i,t,JSON.parse(s[t]),a,path.join(process.env.projectPath,e))}),t[e.replace(n,"")+".json"]={source:function(){return JSON.stringify(i,null,2)},size:function(){return JSON.stringify(i,null,2).size}},delete t[e]}}catch(t){a.errors.push({message:"errorStartERROR File："+e+"\n "+" ".concat(t.message)+"errorEnd"})}}function elementChange(element,source,jsonOut){if(""===element.trim()||"//"===element.trim());else{var key=element.match(/var ((\s||\S)*) =/)[1],value=element.match(/"((\s||\S)*)"/)[1],replaceSource=source.replace(element,"").toString(),partStart=replaceSource.indexOf(value),subSource=replaceSource.substr(partStart),partEnd=subSource.indexOf("/***/ })"),out=subSource.substr(0,partEnd).match(/module\.exports \= ((\s||\S)*)/)[1].trim();0===out.indexOf("JSON.parse(")&&(out=JSON.stringify(eval(out))),";"===out.substr(out.length-1,1)&&(out=out.substr(0,out.length-1)),jsonOut[key]=out}}function toAddJson(e,t,a,r,n){switch(e.template=e.template||{},e.styles=e.styles||{},e.data=e.data||{},e.actions=e.actions||{},e.apiVersion=e.apiVersion||{},t){case"card_template":e.template=a;break;case"card_style":e.styles=a;break;case"card_json":a&&(a.data&&(e.data=validateData(a.data,r,n)),a.actions&&(e.actions=processActions(a.actions,r,n)),a.apiVersion&&(e.apiVersion=validateData(a.apiVersion,r,n)),a.props&&(e.props=replacePropsArray(a.propsValue,r,n)));break;default:addElement(e,t,a,r,n)}}function addElement(e,t,a,r,n){var s=t.substr(t.lastIndexOf("_")+1,t.length-t.lastIndexOf("_")+1);switch(e[s]=e[s]||{},e[s].template=e[s].template||{},e[s].styles=e[s].styles||{},e[s].data=e[s].data||{},e[s].actions=e[s].actions||{},e[s].apiVersion=e[s].apiVersion||{},t.replace(s,"")){case"card_element_template_":e[s].template=a;break;case"card_element_style_":e[s].styles=a;break;case"card_element_json_":a&&(a.data&&(e[s].data=validateData(a.data,r,n)),a.actions&&(e[s].actions=processActions(a.actions,r,n)),a.apiVersion&&(e[s].apiVersion=validateData(a.apiVersion,r,n)),a.props&&(e[s].props=replacePropsArray(a.propsValue,r,n)))}}function replacePropsArray(e,t,a){var r=this;if(!e)return e;if(Array.isArray(e)){var n={};e.forEach(function(e){(0,_newArrowCheck2.default)(this,r),"string"!=typeof e&&t.warnings.push({message:"warnStartWARNING File："+a+"\n "+" The props value type should be 'string', not '".concat((0,_typeof2.default)(e),"' in props array in custom elements.")+"warnEnd"}),n[e]={default:""}}.bind(this)),e=n}else"[object Object]"===Object.prototype.toString.call(e)?Object.keys(e).forEach(function(n){(0,_newArrowCheck2.default)(this,r),"[object Object]"!==Object.prototype.toString.call(e[n])&&t.warnings.push({message:"warnStartWARNING File："+a+"\n  The props default value type can only be Object in custom elements.warnEnd"}),e[n].hasOwnProperty("default")||(e[n]={default:""})}.bind(this)):t.warnings.push({message:"warnStartWARNING File："+a+"\n  The props type can only be Array or Object in custom elements.warnEnd"});return e}function processActions(e,t,a){var r=this;return"[object Object]"===Object.prototype.toString.call(e)?Object.keys(e).forEach(function(n){(0,_newArrowCheck2.default)(this,r),e[n].method&&("string"==typeof e[n].method?e[n].method.toLowerCase()!==e[n].method&&(t.warnings.push({message:"warnStartWARNING File："+a+"\n "+" The key method '".concat(e[n].method,"' in the actions don't support uppercase letters.")+"warnEnd"}),e[n].method=e[n].method.toLowerCase()):t.warnings.push({message:"warnStartWARNING File："+a+"\n "+" The key method type in the actions should be 'string', not '".concat((0,_typeof2.default)(e[n].method),"'.")+"warnEnd"}))}.bind(this)):e&&t.warnings.push({message:"warnStartWARNING File："+a+"\n  The actions value type can only be Object.warnEnd"}),e}function validateData(e,t,a){return e&&"[object Object]"!==Object.prototype.toString.call(e)&&t.warnings.push({message:"warnStartWARNING File："+a+"\n  The data value type can only be Object.warnEnd"}),e}module.exports={AfterEmitPlugin:AfterEmitPlugin};
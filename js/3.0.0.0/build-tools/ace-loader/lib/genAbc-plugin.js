"use strict";var output,webpackPath,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fs=require("fs"),path=require("path"),process=require("child_process"),arkDir=path.join(__dirname,"..","bin","ark"),forward='(global.___mainEntry___ = function (globalObjects) {\n  var define = globalObjects.define;\n  var require = globalObjects.require;\n  var bootstrap = globalObjects.bootstrap;\n  var register = globalObjects.register;\n  var render = globalObjects.render;\n  var $app_define$ = globalObjects.$app_define$;\n  var $app_bootstrap$ = globalObjects.$app_bootstrap$;\n  var $app_require$ = globalObjects.$app_require$;\n  var history = globalObjects.history;\n  var Image = globalObjects.Image;\n  var OffscreenCanvas = globalObjects.OffscreenCanvas;\n  (function(global) {\n    "use strict";\n',last="\n})(this.__appProto__);\n})",firstFileEXT="_.js",isWin=!1,isMac=!1,isDebug=!1,GenAbcPlugin=function(){function e(r,a,s){(0,_classCallCheck2.default)(this,e),output=r,webpackPath=a,isDebug=s}return(0,_createClass2.default)(e,[{key:"apply",value:function(e){var r=this;if(fs.existsSync(path.resolve(webpackPath,"ark/build-win")))isWin=!0;else if(fs.existsSync(path.resolve(webpackPath,"ark/build-mac")))isMac=!0;else if(!fs.existsSync(path.resolve(webpackPath,"ark/build")))return void console.error("[31m","find build fail","[39m");e.hooks.emit.tap("GenAbcPlugin",function(e){var a=this;(0,_newArrowCheck2.default)(this,r);var s=e.assets;Object.keys(s).forEach(function(e){if((0,_newArrowCheck2.default)(this,a),output&&webpackPath&&".js"===path.extname(e)){var r=s[e].source();0!==e.search("./workers/")&&(r=forward+r+last);var t=e.replace(/\.js$/,firstFileEXT);writeFileSync(r,path.resolve(output,t),e)}}.bind(this))}.bind(this))}}]),e}();function writeFileSync(e,r,a){var s=path.join(r,"..");fs.existsSync(s)&&fs.statSync(s).isDirectory()||mkDir(s),fs.writeFileSync(r,e),fs.existsSync(r)?jsFirst(r):console.error("[31m","Failed to convert file ".concat(a," to bin. ").concat(r," is lost"),"[39m")}function mkDir(e){var r=path.join(e,"..");fs.existsSync(r)&&!fs.statSync(r).isFile()||mkDir(r),fs.mkdirSync(e)}function jsFirst(e){var r="-r";isDebug&&(r+=" --debug");var a=path.join(arkDir,"build","src","index.js");isWin?a=path.join(arkDir,"build-win","src","index.js"):isMac&&(a=path.join(arkDir,"build-mac","src","index.js"));var s='node --expose-gc "'.concat(a,'" "').concat(e,'" ').concat(r);try{process.execSync(s),console.info(s)}catch(r){console.error("[31m","Failed to convert file ".concat(e," to abc"),"[39m")}fs.existsSync(e)?fs.unlinkSync(e):console.error("[31m","Failed to convert file ".concat(e," to abc. ").concat(e," is lost"),"[39m");var t=e.replace(/\.js$/,".abc");if(fs.existsSync(t)){var i=t.replace(/\_.abc$/,".abc");fs.renameSync(t,i)}else console.error("[31m","".concat(t," is lost"),"[39m")}module.exports=GenAbcPlugin;
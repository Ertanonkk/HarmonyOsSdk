const content=require("./content"),data=require("./data"),{DEVICE_LEVEL:DEVICE_LEVEL}=require("../lite/lite-enum"),card=process.env.DEVICE_LEVEL===DEVICE_LEVEL.CARD,REG_CARD_ARRAY=/(\['.+?'\])|(\[".+?"\])/g;function transExp(e,n,r,t,c){let a=e.toString().trim();return isExp(a)&&(a=parseExp(a,n,r,t,c)),a}function parseExp(value,functionFlag,isValue,out,nodeLoc){const textArray=data.parseText(value),explist=[];for(let e=0;e<textArray.length;e++){const n=textArray[e];let r;n.tag?(card&&checkCard(n.value,out,nodeLoc),r=card?`{{${transCardArray(n.value)}}}`:content.parseExpression(n.value),1===textArray.length||card||(r=`(${r})`)):r=card?n.value:`decodeURI('${encodeURI(n.value).replace(/\'/g,"%27")}')`,explist.push(r)}card&&checkCardVersionLimit()&&isValue&&explist.length>1&&out.log.push({line:nodeLoc.line||1,column:nodeLoc.col||1,reason:"ERROR: Variable concatenation is not supported currently."});let func=explist.join(card?"":" + ");return!1===functionFlag||card||(func=eval("(function () {return "+func+"})")),func=card&&textArray.length>1?"$f("+func+")":func,func}function transExpForList(e){let n=e.toString().trim();return containExp(n)&&(n=parseExpList(n)),n}function parseExpList(e){const n=e.match(/{{{([\s\S]+?)}}}|{{([\s\S]+?)}}/g);let r=0;const t=[];return e.replace(/{{{([\s\S]+?)}}}|{{([\s\S]+?)}}/g,"&e").split(/\s+/).forEach(e=>{if(e.indexOf("&e")>=0){for(;e.indexOf("&e")>=0;)e=e.replace("&e",n[r++]);const c=data.parseText(e),a=[];c&&(c.forEach(function(e){const n=e.tag?card?`{{${e.value}}}`:content.parseExpression(e.value):card?e.value:`'${e.value}'`;a.push(n)}),t.push(a.join("+")))}else{const n=card?e:`'${e}'`;t.push(n)}}),card?t:"(function () {return ["+t.join(", ")+"]})"}function isExp(e){return/{{{([\s\S]+?)}}}|{{([\s\S]+?)}}/.test(e)}function containExp(e){return/{{{([\s\S]+?)}}}|{{([\s\S]+?)}}/g.test(e)}function removeAllExpFix(e){return containExp(e)?e.replace(/\{\{\{?|\}\}\}?/g,""):e}function transCardArray(e){return"."===(e=e.replace(REG_CARD_ARRAY,e=>`.${e.slice(2,-2)}.`)).charAt(e.length-1)&&(e=e.slice(0,-1)),e}function checkCard(e,n,r){checkApi(e)||checkIdxAndItem(e)||(checkCardVersionLimit()&&!checkVariable(e)?n.log.push({line:r.line||1,column:r.col||1,reason:`ERROR: Version 5: The expression ${e}' is not supported. Only single variables are supported.`}):checkCardVersionLimit()||checkExpression(e)||n.log.push({line:r.line||1,column:r.col||1,reason:`ERROR: Version 6: The expression '${e}' is not supported.`+"Only the binocular expression, OR expression, AND expression, and NOT expression are supported."}))}function checkCardVersionLimit(){return parseInt(process.env.PLATFORM_VERSION.replace("Version",""))<6}function checkApi(e){return/^\$(tc|t|r)/m.test(e)}function checkExpression(e){return checkVariable(e)||checkOR(e)||checkAND(e)||checkNOT(e)||checkBinocular(e)}function checkIdxAndItem(e){return"$idx"===e||"$item"===e}function checkVariable(e){return/^[a-zA-Z\$_][a-zA-Z\d_\.\[\]'"`\s]*$/.test(e)}function checkOR(e){return/^[a-zA-Z\$_][a-zA-Z\d_\.\[\]'"`\s]*\|\|[a-zA-Z\$_\s][a-zA-Z\d_\.\[\]'"`\s]*$/m.test(e)}function checkAND(e){return/^[a-zA-Z\$_][a-zA-Z\d_\.\[\]'"`\s]*&&[a-zA-Z\$_\s][a-zA-Z\d_\.\[\]'"`\s]*$/m.test(e)}function checkNOT(e){return/^![a-zA-Z\$_][a-zA-Z\d_\.\[\]'"`\s]*$/m.test(e)}function checkBinocular(e){return/^[a-zA-Z\$_][a-zA-Z\d_\.\[\]'"`\s]*\?[a-zA-Z\$_\s][a-zA-Z\d_\.\[\]'"`\s]*:[a-zA-Z\$_\s][a-zA-Z\d_\.\[\]'"`\s]*$/m.test(e)}transExp.checkApi=checkApi,transExp.checkExpression=checkExpression,transExp.checkIdxAndItem=checkIdxAndItem,transExp.checkVariable=checkVariable,transExp.checkAND=checkAND,transExp.checkOR=checkOR,transExp.checkNOT=checkNOT,transExp.isExp=isExp,transExp.containExp=containExp,transExp.removeAllExpFix=removeAllExpFix,transExp.transExpForList=transExpForList,transExp.transCardArray=transCardArray,module.exports=transExp;
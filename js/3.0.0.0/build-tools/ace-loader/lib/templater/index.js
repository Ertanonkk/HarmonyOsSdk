const componentValidator=require("./component_validator"),Parser=require("../parse/parser/index"),path=require("path");let compileResult;const EVENT_START_REGEXP=/^(on:|on|@|grab:)/,REGEXP_TEXT=/^#/,REGEXP_DATA=/^data-/;function parse(e,t,o){const l=path.parse(o);let a=l.dir.replace(process.env.aceModuleRoot||process.cwd(),"")+"/"+l.base.replace(l.ext,"");a=replaceAll(path.sep,"/",a).replace("/","");compileResult={jsonTemplate:{},deps:[],log:[]};const n=hmlParse(e,{sourceCodeLocationInfo:!0});if(checkNullNode(n,t)||checkRootNode(n,t,a))return;const c=n.childNodes.filter(function(e){return-1===e.nodeName.indexOf("#")});let r=0;c.forEach((e,t)=>{"element"!==e.tagName&&(r=t)}),generate(c[r],o,void 0,a),t(null,compileResult)}function hmlParse(e,t){return new Parser({sourceCodeLocationInfo:!0,componentValidator:componentValidator,compileResult:compileResult}).parseFragment(e,t)}function checkNullNode(e,t){let o=!1;return 0===e.childNodes.length&&(compileResult.log.push({reason:"ERROR: parsing hml file failed"}),t(null,compileResult),o=!0),o}function checkRootNode(e,t,o){let l=!1;let a=0;return e.childNodes.filter(function(e){return-1===e.nodeName.indexOf("#")}).forEach(e=>{if("element"!==e.nodeName)a++;else if(e.attrs&&e.attrs.length)for(let t=0;t<e.attrs.length;t++){const l=e.attrs[t];if("name"===l.name){componentValidator.elementNames[o]=componentValidator.elementNames[o]||[],componentValidator.elementNames[o].push(l.value);break}}}),1!==a&&(a||compileResult.log.push({reason:"ERROR: need a legal root node",line:1,column:1}),a>1&&compileResult.log.push({reason:"ERROR: there can only be one root node",line:1,column:1}),t(null,compileResult),l=!0),l}function generate(e,t,o,l){componentValidator.validateTagName(e,compileResult,l),e.attrs&&0!==e.attrs.length&&checkNodeAttrs(e,t,o,l),e.childNodes&&0!==e.childNodes.length&&checkNodeChildren(e,t,l)}function checkNodeAttrs(e,t,o,l){const a=e.attrs,n={line:e.sourceCodeLocation.startLine,col:e.sourceCodeLocation.endLine};a.forEach((c,r)=>{const i=c.name,s=c.value;switch(i){case"style":componentValidator.validateStyle(s,compileResult,n,l);break;case"class":componentValidator.validateClass(s,compileResult,n,l);break;case"id":componentValidator.validateId(s,compileResult,n,l);break;case"for":checkAttrFor(e,a,n),componentValidator.validateFor(s,compileResult,n,l);break;case"if":componentValidator.validateIf(s,compileResult,!1,n,l);break;case"elif":componentValidator.validateAttrElif(o,s,a,r,compileResult,n,l);break;case"else":componentValidator.validateAttrElse(o,compileResult,n,l);break;case"append":componentValidator.validateAppend(s,compileResult,n,l);break;default:EVENT_START_REGEXP.test(i)?componentValidator.validateEvent(i,s,compileResult,n,l):REGEXP_DATA.test(i)?componentValidator.parseDataAttr(i,s,compileResult,n,l):componentValidator.validateAttr(t,i,s,compileResult,e.tagName,n,l)}})}function checkAttrFor(e,t,o){if("card"===process.env.DEVICE_LEVEL){let l=!1,a=!1;t.forEach(e=>{"tid"===e.name&&(l=!0),"if"!==e.name&&"elif"!==e.name&&"else"!==e.name||(a=!0)}),l||compileResult.log.push({line:o.line||1,column:o.col||1,reason:"WARNING: The 'tid' is recommended here."}),a&&compileResult.log.push({line:o.line||1,column:o.col||1,reason:"ERROR: The 'for' and 'if' cannot be used in the same node."});let n=!1;e&&e.parentNode&&e.parentNode.attrs&&e.parentNode.attrs.forEach(e=>{"for"===e.name&&(n=!0)}),n&&compileResult.log.push({line:o.line||1,column:o.col||1,reason:"ERROR: The nested 'for' is not supported."})}}function replaceAll(e,t,o){return e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),o.replace(new RegExp(e,"g"),t)}function checkNodeChildren(e,t,o){const l=e.childNodes.filter(e=>"#text"===e.nodeName&&e.value.trim()||!REGEXP_TEXT.test(e.nodeName)),a=compileResult.jsonTemplate;for(let n=0;n<l.length;n++){const c=l[n];let r;if(n>0&&(r=l[n-1]),REGEXP_TEXT.test(c.nodeName)){const l={line:c.sourceCodeLocation.startLine,col:c.sourceCodeLocation.endLine};if("option"===e.nodeName){componentValidator.validateAttr(t,"content",c.value,compileResult,c.tagName,l,o);continue}componentValidator.validateAttr(t,"value",c.value,compileResult,c.tagName,l,o)}else compileResult.jsonTemplate={},a.children=a.children||[],a.children.push(compileResult.jsonTemplate),generate(c,t,r,o)}compileResult.jsonTemplate=a}module.exports={parse:parse};
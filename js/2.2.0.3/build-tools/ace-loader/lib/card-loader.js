"use strict";var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_util=require("./util"),_parser=require("./parser");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function loader(e){var t=this;this.cacheable&&this.cacheable();var s=(this._compiler.options.plugins[0].options.options.weex||{}).lang||{},n=this.resourcePath,a=n.replace(_path.default.extname(n).toString(),""),i="";i=(0,_util.getRequireString)(this,(0,_util.jsonLoaders)("template"),n);var o=findStyleFile(a);1==o.extStyle&&(i+=(0,_util.getRequireString)(this,(0,_util.jsonLoaders)("style",s[o.type]),o.styleFileName)),i=addJson(this,i,a,"");var l=(0,_parser.parseFragment)(e),r=new Set;return l.element&&l.element.forEach(function(e){var o;if(e.src){var l=_path.default.join(n,"..",e.src);if(_fs.default.existsSync(l))if(o=e.name?e.name.toLowerCase():_path.default.parse(e.src).name.toLowerCase(),r.has(o))(0,_util.logWarn)(t,[{reason:"ERROR: The custom elements cannot have the same attribute 'name' or file name (case insensitive).",line:e.node.__location.line,column:e.node.__location.col}]);else{r.add(o);var u=l.replace(_path.default.extname(l).toString(),"");i+=(0,_util.getRequireString)(t,(0,_util.jsonLoaders)("template"),l+"?".concat(o,"#").concat(a));var c=findStyleFile(u);1==c.extStyle&&(i+=(0,_util.getRequireString)(t,(0,_util.jsonLoaders)("style",s[c.type]),c.styleFileName+"?".concat(o,"#").concat(a))),i=addJson(t,i,u,"?".concat(o,"#").concat(a))}else(0,_util.logWarn)(t,[{reason:"ERROR: The custom element '".concat(l,"' can not be found."),line:e.node.__location.line,column:e.node.__location.col}])}else(0,_util.logWarn)(t,[{reason:"ERROR: The attribute 'src' must be set in the custom element.",line:e.node.__location.line,column:e.node.__location.col}])}),i}function findStyleFile(e){var t=!1,s=e+".css",n="css";return _fs.default.existsSync(s)?(t=!0,n="css"):(s=e+".less",_fs.default.existsSync(s)?(t=!0,n="less"):(s=e+".sass",_fs.default.existsSync(s)?(t=!0,n="sass"):(s=e+".scss",_fs.default.existsSync(s)?(t=!0,n="sass"):t=!1))),{extStyle:t,styleFileName:s,type:n}}function addJson(e,t,s,n){return _fs.default.existsSync(s+".json")&&!_fs.default.existsSync(s+".js")?t+=(0,_util.getRequireString)(e,(0,_util.jsonLoaders)("json"),s+".json"+n):_fs.default.existsSync(s+".js")&&!_fs.default.existsSync(s+".json")?t+=(0,_util.getRequireString)(e,(0,_util.jsonLoaders)("json"),s+".js"+n):_fs.default.existsSync(s+".json")&&_fs.default.existsSync(s+".js")&&((0,_util.logWarn)(e,[{reason:"WARNING: '".concat(s,"' cannot have the same name files '.json' and '.js', otherwise '.json' in default.")}]),t+=(0,_util.getRequireString)(e,(0,_util.jsonLoaders)("json"),s+".json"+n)),t}module.exports=loader;
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var fs=require("fs"),path=require("path"),SingleEntryPlugin=require("webpack/lib/SingleEntryPlugin"),CUSTOM_THEME_PROP_GROUPS=require("./theme/customThemeStyles"),OHOS_THEME_PROP_GROUPS=require("./theme/ohosStyles"),FILE_EXT_NAME=[".js",".css",".jsx",".less",".sass",".scss",".md",".DS_Store",".hml"],red="[31m",reset="[39m",input="",output="",manifestFilePath="",shareThemePath="",internalThemePath="";function copyFile(e,t){try{if(fs.existsSync(e)){var n=path.join(t,"..");fs.existsSync(n)&&fs.statSync(n).isDirectory()||mkDir(n);var i=path.parse(e),r=addPageEntryObj(),s=i.dir+path.sep+i.name+".hml?entry";for(var a in r)if(r[a]===s)return;if(".json"===i.ext&&(i.dir===shareThemePath||i.dir===internalThemePath)&&themeFileBuild(e,t))return;var o=fs.createReadStream(e),c=fs.createWriteStream(t);o.pipe(c),o.on("close",function(){c.end()})}}catch(t){throw console.error(red,"Failed to build file ".concat(e,"."),reset),t.message}}function mkDir(e){var t=path.join(e,"..");fs.existsSync(t)&&!fs.statSync(t).isFile()||mkDir(t),fs.mkdirSync(e)}function circularFile(e,t,n){var i=path.join(e,n);fs.existsSync(i)&&i!==output&&fs.readdirSync(i).forEach(function(r){var s=path.join(i,r),a=fs.statSync(s);if(a.isFile()){var o=path.basename(s),c=path.extname(s);if(FILE_EXT_NAME.indexOf(c)<0&&".DS_Store"!==o){var l=path.join(t,n,path.basename(r));if(l===path.join(output,"manifest.json"))return;if(fs.existsSync(l)){var u=fs.statSync(l);u.isFile()&&a.size!==u.size&&copyFile(s,l)}else copyFile(s,l)}}else a.isDirectory()&&circularFile(e,t,path.join(n,r))})}var ResourcePlugin=function(){function e(t,n,i){_classCallCheck(this,e),input=t,output=n,manifestFilePath=i,shareThemePath=path.join(t,"../share/resources/styles"),internalThemePath=path.join(t,"resources/styles")}return _createClass(e,[{key:"apply",value:function(e){e.hooks.beforeCompile.tap("resource Copy",function(){circularFile(input,output,""),circularFile(input,output,"../share")}),e.hooks.normalModuleFactory.tap("OtherEntryOptionPlugin",function(){for(var t in addPageEntryObj(),entryObj){if(!e.options.entry[t])new SingleEntryPlugin("",entryObj[t],t).apply(e)}}),e.hooks.done.tap("copyManifest",function(){copyManifest(),fs.existsSync(path.join(output,"app.js"))&&fs.utimesSync(path.join(output,"app.js"),new Date,new Date)})}}]),e}();function copyManifest(){copyFile(manifestFilePath,path.join(output,"manifest.json"))}var entryObj={};function addPageEntryObj(){var e=this;if(entryObj={},!fs.existsSync(manifestFilePath))throw Error("ERROR: missing manifest").message;var t=fs.readFileSync(manifestFilePath).toString(),n=JSON.parse(t).pages;if(void 0===n)throw Error("ERROR: missing pages").message;return n.forEach(function(t){var n=t,i=path.join(input,n+".hml"),r=process.env.aceSuperVisualPath||"",s=path.join(r,n+".visual"),a=fs.existsSync(i),o=fs.existsSync(s);a&&o?logWarn(e,[{reason:"ERROR: "+n+" cannot both have hml && visual"}]):a?entryObj["./"+t]=i+"?entry":o&&(entryObj["./"+t]=s+"?entry")}),entryObj}function themeFileBuild(e,t){if(fs.existsSync(e)){var n=JSON.parse(fs.readFileSync(e)),i={};if(n&&n.style){i.style={};var r=n.style;return Object.keys(r).forEach(function(e){var t=CUSTOM_THEME_PROP_GROUPS[e],n=OHOS_THEME_PROP_GROUPS[e];n?i.style[n]=r[e]:t?i.style[t]=r[e]:i.style[e]=r[e]}),fs.writeFileSync(t,JSON.stringify(i,null,2)),!0}}return!1}module.exports=ResourcePlugin;